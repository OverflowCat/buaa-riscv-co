## 实验目的

设计和实现一个支持 RV32I 指令集的单周期 CPU。通过完成数据通路和控制单元的模块化设计，掌握 CPU 处理流程、指令的执行方式和信号控制流程，加深对单周期处理器结构的理解。

## 实验要求

- 设计实现数据通路模块，包括算术逻辑单元（ALU）、寄存器堆、立即数生成单元、指令存储器和数据存储器。
- 设计控制单元，以生成控制信号来执行 add, sub, and, or, lw, sw, beq 七条指令。
- 使用 Verilog HDL 实现上述模块，并在测试平台上验证正确性。

## 实验所需设备/环境

- 软件：VS Code、iverilog
- 硬件：计算机
- 测试文件：实验所提供的 testbench 文件

## 总体设计方案

如任务书中图2所示。

## 技术实现细节

imm_gen_test
alu_test
regfile_test
data_ram_test
pc_rom_test
ctrl_test
cpu_core_test

### 立即数生成单元

在 `imm_gen` 模块中，通过提取 `instr` 中的不同字段生成 RISC-V 的立即数。代码通过解码 `opcode`（操作码）来识别指令类型，分别生成适合 I-type、S-type、B-type、U-type 和 J-type 指令格式的立即数。

每种指令类型具有不同的立即数格式和位分布。具体地，I-type 直接从位 [31:20] 提取立即数，并进行符号扩展；S-type 使用位 [31:25] 和 [11:7] 拼接成 12 位立即数；B-type 将不同位段按特定顺序拼接，并在最低位填充 0；U-type 直接将高 20 位与 12 位零拼接；J-type 则拼接位 [30:21]、[20]、[19:12]，并在最低位填充 0。

### ALU

通过 `ALUCtrl` 控制信号来选择不同的操作。ALU 根据 `ALUCtrl` 值执行相应的运算，结果保存在 `out` 寄存器中。比较重要的是模块的另一个输出信号 `ZERO`，需要根据 `out` 的值来设置，对于分支指令（如 `BEQ`）的跳转判断非常重要。

### 寄存器堆

在 regfile 模块中，通过32个32位寄存器构成的寄存器堆实现了读写操作。所有寄存器在初始化时被设为零，确保0号寄存器始终保持零值。两个读端口分别由A1和A2指定，用于从对应的寄存器读取数据。如果读取的是0号寄存器，则返回零值。写操作在时钟上升沿进行，当写使能信号WE为1时，将WD3的数据写入A3指定的寄存器，符合RISC-V标准。

### RAM

通过一个32位宽的存储器和两个读写端口实现了数据存储器的功能。读写操作通过地址和控制信号来控制。

### PC ROM

通过将PC地址A的高两位移除（即A >> 2），从指令存储器mem中读取32位指令数据并输出至RD。存储器为一个32位宽、1042行的寄存器数组mem，可以存储多条指令。$readmemb语句在模块初始化时从文件中读取指令数据到mem，注意路径是文件的相对路径，在本地测试和平台上测试时需要修改，并且单元测试和顶层测试时使用不一样的数据文件。

### 控制单元

control模块根据instr（指令）的opcode、funct3和funct7字段来解析指令类型并生成相应的控制信号。

对于R-type指令，根据funct3和funct7确定ALU操作，其中funct7中的第6位用于区分加法和减法操作。I-type load指令使用立即数作为ALU的一个输入，通过设置alusrc为1。S-type `sw` 指令设置ALU为减法操作，通过结果的零标志来决定是否跳转。

### 数据通路

data_path模块控制PC的更新。在每个时钟上升沿，若branch和zero同时为1，则PC值更新为当前PC加上立即数imm（实现分支跳转）。否则，PC按照顺序执行（PC加4）。所有的子模块通过`` `include``语句导入到测试路径下的不同文件中。

### 顶层模块

顶层模块的主要信号连接完成了指令地址计算、指令解码、立即数生成、寄存器文件访问、ALU计算、以及数据存储器的访问。ALU操作数选择通过alusrc信号控制，当alusrc为1时，使用立即数作为ALU的B输入，否则使用寄存器的读数据reg_rdata2。最终结果alu_out作为写回寄存器或数据存储器地址的选择依据。
